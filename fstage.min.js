/**
 * FSTAGE
 *
 * About: A lean javascript library for developing modern web apps
 * Version: 0.0.1
 * License: MIT
 * Source: https://github.com/codi0/fstage
 *
 * Assumes support for: Promise, fetch, Proxy (IE is dead)
 * Checks support for: Symbol.iterator, AbortController
**/
!function(e){"use strict";var t=function(e,n){return t.win&&e===window?t.win:t.doc&&e===document?t.doc:new t.select(e,n,!1)};t.select=function(e,t=document,n=!0){if("string"==typeof e&&(e=/^#[\w-]*$/.test(e)?t.getElementById(e.substr(1)):/^\.[\w-]*$/.test(e)?t.getElementsByClassName(e.substr(1)):/^\w+$/.test(e)?t.getElementsByTagName(e):t.querySelectorAll(e)),e&&!e.nodeType&&e!==window||(e=e?[e]:[]),n)return e;this.length=e.length;for(var r=0;r<e.length;r++)this[r]=e[r]},t.v="0.0.1",t.win=t(window),t.doc=t(document),t.fn=t.prototype=t.select.prototype,t.prototype.length=0,t.prototype.splice=Array.prototype.splice,t.prototype.get=function(e){return this[e]},t.prototype.each=function(e){for(var t=0;t<this.length&&!1!==e.call(this[t],t,this[t]);t++);},"function"==typeof Symbol&&(t.prototype[Symbol.iterator]=Array.prototype[Symbol.iterator]),window.Fstage=t,window.$=window.$||t,"object"==typeof module&&module.exports&&(module.exports=t),"function"==typeof define&&define.amd&&define("fstage",[],function(){return t}),t.each=function(e,t){if("length"in e)for(var n=0;n<e.length&&!1!==t.call(e[n],n,e[n]);n++);else for(var n in e)if(e.hasOwnProperty(n)&&!1===t.call(e[n],n,e[n]))break},t.extend=function(e={}){for(var t=0;t<arguments.length;t++)if(t)for(var n in arguments[t])arguments[t].hasOwnProperty(n)&&(e[n]=arguments[t][n]);return e},t.type=function(e){return{}.toString.call(e).match(/\s([a-zA-Z]+)/)[1].toLowerCase()},t.toNodes=function(e,t=!1){return e="string"==typeof e?(new DOMParser).parseFromString(e,"text/html").body.childNodes:e&&e.tagName?[e]:e||[],t?e[0]||null:e},t.stripHtml=function(e){var t=document.createElement("div");return t.innerHTML=String(e),t.textContent},t.escHtml=function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;",":":"&#58;"};return String(e).replace(/&amp;/g,"&").replace(/[&<>"'\/:]/g,function(e){return t[e]})},t.copy=function(e,n={}){var r=t.type(e);if("string"===r&&n.sanitize)return n.sanitize(e);if("object"!==r&&"array"!==r)return e;var o="array"===r?[]:{};return t.each(e,function(e,r){n.skip&&n.skip.includes(e)||(o[e]=t.copy(r,n))}),o},t.debounce=function(e,t=100){var n;return function(){var r=this,o=arguments;n&&clearTimeout(n),n=setTimeout(function(){e.apply(r,o)},t)}},t.ready=t.prototype.ready=function(e){if(/comp|inter|loaded/.test(document.readyState))return e();document.addEventListener("DOMContentLoaded",e)},t.hash=function(e){"string"!=typeof e&&(e=JSON.stringify(e));for(var t=5381,n=e.length;n;)t=33*t^e.charCodeAt(--n);return(t>>>0).toString()},t.deviceId=function(e=""){return t.hash(e+navigator.userAgent.replace(/[0-9\.]/g,""))},t.prototype.find=function(e){for(var n=[],r=0;r<this.length;r++)for(var o=t.select(e,this[r]),i=0;i<o.length;i++)n.push(o[i]);return t(n)},t.prototype.closest=t.closest=function(e,n=null){for(var r=[],o=n?[n]:this,i=0;i<o.length;i++)for(var s=o[i];s&&s!==document;){if(s.matches(e)){r.push(s);break}s=s.parentNode}return t(r)},t.prototype.parent=function(){for(var e=0;e<this.length;e++)this[e]=this[e].parentNode;return this};var n=0;t.prototype.on=function(e,r,o,i=!1){"function"==typeof r&&(i=i||o,o=r,r=null),o.guid=o.guid||++n,e=e.trim().split(/\s+/g);for(var s=0;s<e.length;s++)for(var a=0;a<this.length;a++)!function(e,n){if(n.events=n.events||{},!n.events[e]){n.events[e]=n.events[e]||{};var s=function(t){if("click"===e||"submit"===e){if(s._stopDbl)return t.preventDefault();s._stopDbl=!0,setTimeout(function(){delete s._stopDbl},300)}for(var r in n.events[e])if(n.events[e].hasOwnProperty(r)&&!1===n.events[e][r].call(this,t))return t.stopPropagation()};n.addEventListener(e,s,{capture:!1,passive:/scroll|wheel|mouse|touch|pointer/.test(e)})}n.events[e][o.guid]=function(s){var a=this;if(i&&delete n.events[e][o.guid],r){var u=t.closest(r,s.target);if(!u.length)return;a=u[0]}return o.call(a,s)}}(e[s],this[a]);return this},t.prototype.one=function(e,t,n){return this.on(e,t,n,!0)},t.prototype.off=function(e,t,n){"function"==typeof t&&(n=t),e=e.trim().split(/\s+/g);for(var r=0;r<e.length;r++)for(var o=0;o<this.length;o++){var i=e[r],s=this[o];s.events&&s.events[i]&&s.events[i][n.guid]&&delete s.events[i][n.guid]}},t.prototype.trigger=function(e,t={}){e=e.trim().split(/\s+/g);for(var n=0;n<e.length;n++)for(var r=0;r<this.length;r++){var o=new CustomEvent(e[n],{bubbles:!0,cancelable:!0,detail:t});this[r].dispatchEvent(o)}return this},t.prototype.hasClass=function(e,n=!0,r="contains"){var o=null,i="contains"===r;n&&e&&(e=t.escHtml(e)),e=e.trim().split(/\s+/g);for(var s=0;s<this.length;s++){for(var a=0;a<e.length;a++)if(""!==e[a]){var u=this[s].classList[r](e[a]);i&&!1!==o&&(o=u)}if(i)break}return i?o||!1:this},t.prototype.addClass=function(e,t=!0){return this.hasClass(e,t,"add")},t.prototype.removeClass=function(e,t=!0){return this.hasClass(e,t,"remove")},t.prototype.toggleClass=function(e,t=!0){return this.hasClass(e,t,"toggle")},t.prototype.css=function(e,n,r=!0){if(void 0===n)return this[0]&&this[0].style[e]||"";r&&null!==n&&(e=t.escHtml(e),n=t.escHtml(n));for(var o=0;o<this.length;o++)null===n?this[o].style.removeProperty(e):this[o].style.setProperty(e,n);return this},t.prototype.attr=function(e,n,r=!0){if(void 0===n)return this[0]?this[0].getAttribute(e):"";r&&null!==n&&(e=t.escHtml(e),n=t.escHtml(n));for(var o=0;o<this.length;o++)null===n?this[o].removeAttribute(e):this[o].setAttribute(e,n);return this},t.prototype.append=function(e,n="append"){for(var r=t.toNodes(e),o=0;o<this.length;o++)for(var i=0;i<r.length;i++)"append"===n?this[o].appendChild(r[i]):"prepend"===n?this[o].insertBefore(r[i],this[o].firstChild):"before"===n?this[o].parentNode.insertBefore(r[i],this[o]):"after"===n?this[o].parentNode.insertBefore(r[i],this[o].nextSibling):"wrap"===n?(this[o].parentNode.insertBefore(r[i],this[o]),r[i].appendChild(this[o])):"replace"===n&&this[o].parentNode.replaceChild(r[i],this[o]);return this},t.prototype.prepend=function(e){return this.append(e,"prepend")},t.prototype.after=function(e){return this.append(e,"after")},t.prototype.before=function(e){return this.append(e,"before")},t.prototype.wrap=function(e){return this.append(e,"wrap")},t.prototype.replaceWith=function(e){return this.append(e,"replace")},t.prototype.remove=function(e){for(var t=0;t<this.length;t++)e?!0===e?this[t].innerHTML="":this[t].removeChild(e):this[t].parentNode.removeChild(this[t]);return this},t.prototype.empty=function(){return this.remove(!0)},t.prototype.html=function(e,t="innerHTML"){if(void 0===e)return this[0]?this[0][t]:"";for(var n=0;n<this.length;n++)this[n][t]=e;return this},t.prototype.text=function(e){return this.html(e,"textContent")},t.prototype.val=function(e,n=!0){if(void 0===e)return this[0]?this[0].value:"";n&&e&&(e=t.escHtml(e));for(var r=0;r<this.length;r++)this[r].value=e||"";return this},t.prototype.animate=function(e,t={}){for(var n=/(^|\s|\-)in(\s|\-|$)/.test(e),r=/(^|\s|\-)out(\s|\-|$)/.test(e),o=0;o<this.length;o++)!function(o){var i=o.classList.contains("hidden");if(!(r&&i||n&&!i)){var s=function(e){t.onStart&&t.onStart(e),o.removeEventListener("transitionstart",s)},a=function(n){r&&o.classList.add("hidden"),o.classList.remove("animate"),o.classList.remove.apply(o.classList,e.split(/\s+/g)),t.onEnd&&t.onEnd(n),o.removeEventListener("transitionend",a),o.removeEventListener("transitioncancel",a)};o.addEventListener("transitionstart",s),o.addEventListener("transitionend",a),o.addEventListener("transitioncancel",a),r?o.classList.remove("hidden"):o.classList.add.apply(o.classList,e.split(/\s+/g)),requestAnimationFrame(function(){o.classList.add("animate"),r?o.classList.add.apply(o.classList,e.split(/\s+/g)):o.classList.remove("hidden")})}}(this[o]);return this},t.prototype.sliding=function(e={}){var n,r,o;e=t.extend({x:!0,y:!1},e);var i=function(e,t){return e.touchMoves?e.touchMoves[0][t]:e[t]},s=function(t){if(n){var s=i(t,"pageX"),a=i(t,"pageY"),u=e.x?s-r:r,l=e.y?a-o:o;n.style.transform="translate3d("+u+"px, "+l+"px, 0);",e.onMove&&e.onMove(n,{startX:r,startY:o,pageX:s,pageY:a})}},a=function(u){n&&(t(document).off("mousemove touchmove",s).off("mouseup touchend",a),n.style.transition="transform 300ms ease-in-out",requestAnimationFrame(function(){var t="string"!=typeof n.style.transform,s=function(e){!t&&n.removeEventListener("transitionend",s),n&&(n.style.transition=null),n&&(n.style.userSelect=null),n=r=o=null};!t&&n.addEventListener("transitionend",s),e.onEnd&&e.onEnd(n,{startX:r,startY:o,pageX:i(u,"pageX"),pageY:i(u,"pageY")}),n&&(n.style.transform=null),t&&s()}))};this.on("mousedown touchstart",function(u){n||(n=this,r=i(u,"pageX"),o=i(u,"pageY"),n.style.userSelect="none",t(document).on("mousemove touchmove",s).on("mouseup touchend",a),e.onStart&&e.onStart(n,{startX:r,startY:o}))})},t.pageTransition=function(e,n,r,o,i={}){r&&((r=t(r)).css("z-index",i.reverse?99:98),r.animate((i.reverse?n:o)+" out")),(e=t(e)).css("z-index",i.reverse?98:99),e.animate((i.reverse?o:n)+" in",{onStart:i.onStart,onEnd:function(t){r&&(r.addClass("hidden"),r.attr("style",null)),e.attr("style",null),i.onEnd&&i.onEnd(t)}})},t.ajax=function(e,n={}){var r="undefined"!=typeof AbortController?new AbortController:null;n=t.extend({timeout:5e3,signal:r&&r.signal},n);var o=new Promise(function(t,o){var i=n.timeout&&setTimeout(function(){o(new Error("Ajax request timeout")),r&&r.abort()},n.timeout);fetch(e,n).finally(function(){i&&clearTimeout(i)}).then(t,o)});return n.success&&(o=o.then(function(e){n.success(e)})),n.error&&(o=o.catch(function(e){n.error(e)})),o},t.websocket=function(e,n={},r=!1){if(!0!==r)return new t.websocket(e,n,!0);n=t.extend({protocols:[],retries:50,wait:2e3},n);var o=this,i=!1,s=0,a={},u=[],l={},c=function(e,t="message",n=null,r=!1){a[t]=a[t]||[],a[t]=a[t].filter(function(t){return t.listener!==e||t.channel!==n}),r||a[t].push({listener:e,channel:n})},f=function(e,t){for(var n=0;n<(a[e]||[]).length;n++){var r,o=a[e][n];if(!e||["open","message","error","close"].includes(e))return o.listener(t);try{r=JSON.parse(t.data)}catch(e){}if(!r||r.event!==e)return;o.channel&&r.channel!==o.channel||o.listener(r.data||r.message||r,t)}};return o.open=function(){if(!o.ws)return o.ws=new WebSocket(e.replace(/^http/i,"ws"),n.protocols),o.ws.addEventListener("open",function(e){var t=u;u=[],i=!0;for(var n=0;n<t.length;n++)o.send.apply(o,t[n]);f("open",e)}),o.ws.addEventListener("message",function(e){for(var t in f("message",e),a)a.hasOwnProperty(t)&&!["open","message","error","close"].includes(t)&&f(t,e)}),o.ws.addEventListener("error",function(e){f("error",e)}),o.ws.addEventListener("close",function(e){o.ws=null,i=!1,l={},f("close",e),1e3===e.code||s>0&&s>=n.retries||setTimeout(function(){s++,o.connect()},n.wait)}),o},o.close=function(e=1e3,t=""){return o.ws&&o.ws.close(e,t),o},o.send=function(e,t={}){return i&&o.ws.send(t.encode?JSON.stringify(e):e),u=u.filter(function(t){return t[0]!==e}),i&&!t.queue||u.push([e,t]),o},o.on=function(e,t){return c(t,e),o},o.off=function(e,t){return c(t,e,null,!0),o},o.trigger=function(e,t){return o.send({event:e,data:t},{encode:!0})},o.sub=function(e,t,n=!1){return c(t,"publish",e,n),l[e]||(o.send({event:"subscribe",channel:e},{encode:!0,queue:!n}),l[e]=!0),o},o.unsub=function(e,t){return o.sub(e,t,!0)},o.pub=function(e,t){return o.send({event:"publish",channel:e,data:t},{encode:!0})},window.addEventListener("beforeunload",function(e){o.close()}),o.open()};var r={};t.pub=function(e,t={}){for(var n=0;n<(r[e]||[]).length;n++)r[e][n](t)},t.sub=function(e,t){r[e]=r[e]||[],r[e].push(t)},t.unsub=function(e,t){for(var n=0;n<(r[e]||[]).length;n++)r[e][n]===t&&r[e].splice(n)};var o,i=[],s=[];t.tick=function(e,t=!1){t?s.push(e):i.push(e),o=o||Promise.resolve().then(function(){var e=i.concat(s);for(o=null,i=[],s=[];e.length;)e.shift().call()})},t.nextTick=function(e){return t.tick(e,!0)},t.syncDom=function(e,t,n={}){var r=function(e,t){e.isEqualNode(t)||n.onCanSkip&&n.onCanSkip(e,t)||(o(e,t),s(e,t))},o=function(e,t){if(11!==t.nodeType&&11!==e.nodeType){for(var n=e.attributes,r=0;r<n.length;r++)e.getAttribute(n[r].name)!==n[r].value&&e.setAttribute(n[r].name,n[r].value);var o=e.attributes;for(r=0;r<o.length;r++)t.hasAttribute(o[r].name)||e.removeAttribute(o[r].name)}},i=function(e,t,n){e[n]=t[n],e[e[n]?"setAttribute":"removeAttribute"](n,"")},s=function(e,t){var n,o,s=t.firstChild,a=e.firstChild;if("TEXTAREA"!==e.nodeName){e:for(;s;){for(o=s.nextSibling;a;){var u=void 0;if(n=a.nextSibling,s.isSameNode&&s.isSameNode(a)){s=o,a=n;continue e}if(a.nodeType===s.nodeType&&(1===a.nodeType&&(u=a.nodeName===s.nodeName)&&r(a,s),3!==a.nodeType&&8!==a.nodeType||(u=!0,a.nodeValue=s.nodeValue)),u){s=o,a=n;continue e}e.removeChild(a),a=n}e.appendChild(s),s=o,a=n}for(;a;){var l=a.nextSibling;e.removeChild(a),a=l}if("INPUT"===e.nodeName&&(i(e,t,"checked"),i(e,t,"disabled"),e.value=t.value,t.hasAttribute("value")||e.removeAttribute("value")),"SELECT"===e.nodeName&&!t.hasAttribute("multiple")){for(var c,f=e.firstChild,d=-1,p=0;f;){if("OPTGROUP"===f.nodeName&&(f=(c=f).firstChild),"OPTION"===f.nodeName){if(f.hasAttribute("selected")){d=p;break}p++}!(f=f.nextSibling)&&c&&(f=c.nextSibling,c=null)}e.selectedIndex=d}if("OPTION"===e.nodeName){if(e.parentNode){var h=e.parentNode,v=h.nodeName;"OPTGROUP"===v&&(v=(h=h.parentNode)&&h.nodeName),"SELECT"!==v||h.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(fromEl.setAttribute("selected","selected"),fromEl.removeAttribute("selected")),h.selectedIndex=-1)}i(e,t,"selected")}}else e.value=t.value},a=e;if("string"==typeof t){var u=document.createElement("div");u.innerHTML=t,t=u.firstChild}if(1===a.nodeType)if(1===t.nodeType){if(e.nodeName!==t.nodeName)for(a=document.createElement(t.nodeName);e.firstChild;)a.appendChild(e.firstChild)}else a=t;if(3===a.nodeType||8===a.nodeType){if(t.nodeType===a.nodeType)return a.nodeValue=t.nodeValue,a;a=t}if(a!==t){if(t.isSameNode&&t.isSameNode(a))return;r(a,t)}return a!==e&&e.parentNode&&e.parentNode.replaceChild(a,e),a},t.watch=function(e,n=null){return(e=e||{}).__link=e.__link||[],n&&!e.__link.includes(n)&&e.__link.push(n),e.__isProxy?e:new Proxy(e,{get:function(e,r){return"__isProxy"===r||("__link"!==r&&"object"==typeof e[r]&&(e[r]=t.watch(e[r],n)),e[r])},set:function(e,n,r){if("__isProxy"!==n&&"__link"!==n&&e[n]!==r){var o=e[n];e[n]=r,t.pub("watch",{obj:e,key:n,from:o,to:r})}return!0},deleteProperty:function(e,n){if("__isProxy"!==n&&"__link"!==n&&void 0!==e[n]){var r=e[n];delete e[n],t.pub("watch",{obj:e,key:n,from:r,to:void 0})}return!0}})},t.component=function(e,n={}){var r,o,i,s,a={name:e,children:[],data:(n=t.extend({el:null,parent:null,data:{},template:function(){},escape:t.escHtml},n)).data};return delete n.data,a.render=function(e,u,l){if(o||(o=!0,i=!0,n.el=e||n.el,a.data=t.watch(u||a.data,a.render),t.sub("watch",function(e){e.obj.__link.includes(a.render)&&(i=!0,a.render())})),!r&&i){r=!0,i=!1;var c=function(){if((e=s||t.select(n.el))&&e.length){s=e;for(var o=t.copy(a.data,{skip:["__isProxy","__link"],sanitize:n.escape}),i=n.template(o)||"",u=0;u<e.length;u++){e[u].setAttribute("data-component",a.name);var l=e[u].cloneNode(!1);l.innerHTML=i,t.syncDom(e[u],l,{onCanSkip:function(t,n){return t.getAttribute("data-component")&&e[u]!==t}})}for(var c=0;c<a.children.length;c++)a.children[c].render(null,null,!0)}r=!1};l?c():t.tick(c)}},n.parent&&n.parent.children.push(a),n.el&&a.render(),a},t.router=new function(){var e=this,n=!1,r=0,o={routes:{},baseUrl:"",home:"home",notfound:"notfound",attr:"data-route",history:!0};e.current=function(){return o.last},e.has=function(e){return o.onHas?o.onHas(e,o.routes):o.routes[e]&&o.routes[e].length},e.on=function(t,n){t=t.trim().split(/\s+/g);for(var r=0;r<t.length;r++){var i=n.bind({});i.runs=0,o.routes[t[r]]=o.routes[t[r]]||[],o.routes[t[r]].push(i)}return e},e.off=function(t,n){return o.routes[t]=(o.routes[t]||[]).filter(function(e){return e!==n}),e},e.trigger=function(n,i={},s="push"){if(i=t.extend({name:n,last:o.last,trigger:null},i),(i=o.onTrigger?o.onTrigger(i):i).is404=!e.has(i.name),i.is404&&!e.has(o.notfound))return!1;if(o.history&&s){var a="scroll"in i?i.scroll||0:window.pageYOffset;history[s+"State"]({id:++r,name:i.name,scroll:a},"",e.url(i.name))}o.last=i.name;for(var u=[i.is404?o.notfound:i.name,"*"],l=0;l<u.length;l++)for(var c=0;c<(o.routes[u[l]]||[]).length;c++){var f=o.routes[u[l]][c];if(f(i,f.runs),f.runs++,i.name!==o.last)return!0}return!0},e.redirect=function(t,n={}){return e.trigger(t,n,"replace")},e.url=function(e,t=!1){if(!o.baseUrl)return location.pathname+location.search;var n=/\?|\#/.test(o.baseUrl)?"":"/",r=(e=o.home===e&&"/"===n?"":e,(o.baseUrl+(e?n+e:"")).replace(/\/\//,"/"));return t?r.replace(/\/$/,""):r},e.start=function(i={}){if(n)return e;n=!0;(o=t.extend(o,i)).notfound;var s=(location.pathname+location.search+location.hash).replace(/\/$/,""),a=s.split(/[^\w-]+/g).pop();return s===e.url(o.home,!0)?a=o.home:a&&e.has(a)||(a=o.notfound),e.redirect(a,{isInitial:!0}),t(window).on("click","["+o.attr+"]",function(n){var r=this.getAttribute(o.attr);if("submit"===this.getAttribute("type")){var i=t.closest("form",this);if(i&&i.length)return i.one("submit",function(t){t.preventDefault(),e.trigger(r)})}n.preventDefault(),e.trigger(r)}),t(window).on("popstate",function(t){if(t.state&&t.state.name){var n=r>t.state.id;r=t.state.id,e.trigger(t.state.name,{isBack:n,scroll:t.state.scroll},null)}}),e}}}();